<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assertion Validation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:opsz,wght@8..60,400;8..60,500;8..60,600&family=DM+Sans:wght@400;500;600&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="/styles.css">
</head>
<body x-data="validationApp()" x-init="init()" :class="{ 'sidebar-collapsed': sidebarCollapsed }">

    <!-- Minimal Header -->
    <header class="header">
        <div class="header-brand">
            <button class="sidebar-toggle" @click="sidebarCollapsed = !sidebarCollapsed" :aria-label="sidebarCollapsed ? 'Show sidebar' : 'Hide sidebar'">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 12h18M3 6h18M3 18h18"/>
                </svg>
            </button>
            <span class="brand-text">Validation</span>
        </div>

        <div class="header-stats" x-show="pendingCounts.total > 0">
            <span class="stat" :class="{ 'has-items': pendingCounts.critical > 0 }">
                <span class="stat-count" x-text="pendingCounts.critical"></span>
                <span class="stat-label">Critical</span>
            </span>
            <span class="stat-divider"></span>
            <span class="stat">
                <span class="stat-count" x-text="pendingCounts.total"></span>
                <span class="stat-label">Pending</span>
            </span>
        </div>

        <div class="header-right">
            <div class="connection-dot" :class="wsConnected ? 'connected' : 'disconnected'" :title="wsConnected ? 'Connected' : 'Disconnected'"></div>
            <input
                type="text"
                x-model="validatorName"
                placeholder="Your name"
                class="validator-input"
                @blur="localStorage.setItem('validatorName', validatorName)"
            >
        </div>
    </header>

    <!-- Main Layout -->
    <main class="main">
        <!-- Sidebar: Assertion List -->
        <aside class="sidebar" :class="{ collapsed: sidebarCollapsed }">
            <div class="sidebar-header">
                <select x-model="selectedProject" @change="loadAssertionsByProject()" class="project-select">
                    <option value="">All Projects</option>
                    <template x-for="project in projects" :key="project.id">
                        <option :value="project.id" x-text="project.name"></option>
                    </template>
                </select>
            </div>

            <div class="assertion-list">
                <template x-if="assertionsByProject.length === 0">
                    <div class="empty-sidebar">
                        <p>No assertions</p>
                    </div>
                </template>

                <template x-for="group in assertionsByProject" :key="group.projectId">
                    <div class="project-section">
                        <button class="project-toggle" @click="group.expanded = !group.expanded">
                            <span class="project-name" x-text="group.projectName"></span>
                            <span class="project-count" x-text="group.assertions.length"></span>
                            <svg class="chevron" :class="{ expanded: group.expanded }" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6 9l6 6 6-6"/>
                            </svg>
                        </button>

                        <div class="project-items" x-show="group.expanded" x-collapse>
                            <template x-for="assertion in group.assertions" :key="assertion.id">
                                <button
                                    class="assertion-item"
                                    :class="{
                                        selected: currentAssertionId === assertion.id,
                                        completed: getAssertionStatus(assertion.id, assertion.status) === 'validated' || getAssertionStatus(assertion.id, assertion.status) === 'rejected'
                                    }"
                                    @click="selectAssertion(assertion)"
                                >
                                    <span class="assertion-status-dot" :class="getAssertionStatus(assertion.id, assertion.status)"></span>
                                    <span class="assertion-preview" x-text="assertion.claim"></span>
                                    <span class="assertion-criticality" :class="assertion.criticality?.toLowerCase()" x-text="assertion.criticality?.charAt(0)"></span>
                                </button>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </aside>

        <!-- Content Area -->
        <section class="content">
            <!-- Empty State -->
            <template x-if="!currentAssertionId">
                <div class="empty-content">
                    <div class="empty-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                    <h2>Select an assertion</h2>
                    <p>Choose from the sidebar to begin validation</p>
                </div>
            </template>

            <!-- Assertion View -->
            <template x-if="currentAssertionId">
                <div class="assertion-view">
                    <!-- Claim Card -->
                    <div class="claim-card">
                        <div class="claim-meta">
                            <span class="entity-name" x-text="currentAssertion?.entityName"></span>
                            <span class="meta-separator">/</span>
                            <span class="category" x-text="currentAssertion?.category"></span>
                            <span class="criticality-tag" :class="currentAssertion?.criticality?.toLowerCase()" x-text="currentAssertion?.criticality"></span>
                        </div>

                        <blockquote class="claim-text" x-text="currentAssertion?.claim"></blockquote>

                        <!-- Sources -->
                        <template x-if="currentAssertion?.sources && currentAssertion.sources.length > 0">
                            <div class="sources-section">
                                <h4>Sources</h4>
                                <template x-for="source in currentAssertion.sources" :key="source.id">
                                    <div class="source-item">
                                        <a :href="source.url" target="_blank" rel="noopener" class="source-url" x-text="source.url"></a>
                                        <template x-if="source.quote">
                                            <p class="source-quote" x-text="source.quote"></p>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <!-- Reasoning -->
                        <template x-if="currentAssertion?.reasoning && currentAssertion.reasoning.length > 0">
                            <div class="reasoning-section">
                                <h4>Reasoning</h4>
                                <template x-for="r in currentAssertion.reasoning" :key="r.id">
                                    <p class="reasoning-text" x-text="r.content"></p>
                                </template>
                            </div>
                        </template>
                    </div>

                    <!-- Status Banner (if completed) -->
                    <template x-if="getAssertionStatus(currentAssertionId) === 'validated'">
                        <div class="status-banner validated">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 6L9 17l-5-5"/>
                            </svg>
                            <span>Validated</span>
                        </div>
                    </template>
                    <template x-if="getAssertionStatus(currentAssertionId) === 'rejected'">
                        <div class="status-banner rejected">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 6L6 18M6 6l12 12"/>
                            </svg>
                            <span>Rejected</span>
                        </div>
                    </template>

                    <!-- Chat Thread -->
                    <div class="chat-thread" x-ref="chatContainer">
                        <template x-for="(msg, index) in chatMessages" :key="index">
                            <div class="message" :class="msg.role">
                                <template x-if="msg.type === 'screenshot'">
                                    <div class="evidence-message">
                                        <img :src="msg.content" alt="Evidence" class="evidence-image">
                                        <a :href="msg.content" target="_blank" class="evidence-link">View full size</a>
                                    </div>
                                </template>
                                <template x-if="msg.type !== 'screenshot'">
                                    <div class="message-bubble" x-html="formatMessage(msg.content)"></div>
                                </template>
                            </div>
                        </template>

                        <!-- Streaming indicator -->
                        <template x-if="isStreaming">
                            <div class="message assistant streaming">
                                <div class="message-bubble">
                                    <span x-text="currentStreamText"></span>
                                    <span class="cursor"></span>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Input Area -->
                    <div class="input-area">
                        <!-- Not started state -->
                        <template x-if="getAssertionStatus(currentAssertionId) === 'not_started'">
                            <div class="start-prompt">
                                <template x-if="!validatorName">
                                    <p class="name-required">Enter your name above to begin</p>
                                </template>
                                <button
                                    class="btn-start"
                                    @click="startAssertionValidation()"
                                    :disabled="!authStatus.valid || !validatorName"
                                >
                                    Begin Validation
                                </button>
                            </div>
                        </template>

                        <!-- Completed state -->
                        <template x-if="getAssertionStatus(currentAssertionId) === 'validated' || getAssertionStatus(currentAssertionId) === 'rejected'">
                            <div class="completed-message">
                                Validation complete
                            </div>
                        </template>

                        <!-- Active validation -->
                        <template x-if="getAssertionStatus(currentAssertionId) === 'in_progress'">
                            <div class="active-input">
                                <!-- Screenshot preview -->
                                <div class="screenshot-preview" x-show="pendingScreenshot">
                                    <img :src="pendingScreenshot?.preview" alt="Screenshot">
                                    <button class="remove-screenshot" @click="clearPendingScreenshot()">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M18 6L6 18M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>

                                <textarea
                                    x-model="userInput"
                                    @input="autoGrow($event)"
                                    @paste="handlePaste($event)"
                                    @keydown.ctrl.enter="submitWithAction('validate')"
                                    @keydown.meta.enter="submitWithAction('validate')"
                                    placeholder="Describe your verification... (Paste screenshots with Ctrl+V)"
                                    :disabled="isStreaming"
                                    class="validation-input"
                                    rows="1"
                                ></textarea>

                                <div class="action-buttons">
                                    <button
                                        class="btn-action question"
                                        @click="sendMessage()"
                                        :disabled="!userInput.trim() || isStreaming"
                                        title="Ask Claude a question"
                                    >
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"/>
                                            <path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/>
                                            <path d="M12 17h.01"/>
                                        </svg>
                                        Ask
                                    </button>
                                    <button
                                        class="btn-action skip"
                                        @click="submitWithAction('skip')"
                                        :disabled="!userInput.trim() || isStreaming"
                                    >
                                        Skip
                                    </button>
                                    <button
                                        class="btn-action reject"
                                        @click="submitWithAction('reject')"
                                        :disabled="!userInput.trim() || isStreaming"
                                    >
                                        Reject
                                    </button>
                                    <button
                                        class="btn-action validate"
                                        @click="submitWithAction('validate')"
                                        :disabled="!userInput.trim() || isStreaming"
                                    >
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                            <path d="M20 6L9 17l-5-5"/>
                                        </svg>
                                        Validate
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </template>
        </section>
    </main>

    <script src="/app.js"></script>
</body>
</html>
