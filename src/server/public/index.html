<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assertion Validation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:opsz,wght@8..60,400;8..60,500;8..60,600&family=DM+Sans:wght@400;500;600&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="/styles.css">
</head>
<body x-data="validationApp()" x-init="init()" :class="{ 'sidebar-collapsed': sidebarCollapsed }">

    <!-- Minimal Header -->
    <header class="header">
        <div class="header-brand">
            <button class="sidebar-toggle" @click="sidebarCollapsed = !sidebarCollapsed" :aria-label="sidebarCollapsed ? 'Show sidebar' : 'Hide sidebar'">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 12h18M3 6h18M3 18h18"/>
                </svg>
            </button>
            <span class="brand-text">Validation</span>
        </div>

        <div class="header-stats">
            <button class="stat-btn validated" :class="{ active: statusFilter === 'validated' }" @click="toggleStatusFilter('validated')">
                <span class="stat-count" x-text="pendingCounts.validated"></span>
                <span class="stat-label">Validated</span>
            </button>
            <button class="stat-btn rejected" :class="{ active: statusFilter === 'rejected' }" @click="toggleStatusFilter('rejected')">
                <span class="stat-count" x-text="pendingCounts.rejected"></span>
                <span class="stat-label">Rejected</span>
            </button>
            <span class="stat-divider"></span>
            <button class="stat-btn" :class="{ active: statusFilter === 'pending', 'has-items': pendingCounts.critical > 0 }" @click="toggleStatusFilter('pending')">
                <span class="stat-count" x-text="pendingCounts.total"></span>
                <span class="stat-label">Pending</span>
            </button>
            <span class="stat-divider"></span>
            <button class="stat-btn" :class="{ active: statusFilter === null }" @click="toggleStatusFilter(null)">
                <span class="stat-label">All</span>
            </button>
        </div>

        <div class="header-right">
            <div class="connection-dot" :class="wsConnected ? 'connected' : 'disconnected'" :title="wsConnected ? 'Connected' : 'Disconnected'"></div>
            <input
                type="text"
                x-model="validatorName"
                placeholder="Your name"
                class="validator-input"
                @blur="localStorage.setItem('validatorName', validatorName)"
            >
        </div>
    </header>

    <!-- Main Layout -->
    <main class="main">
        <!-- Sidebar: Assertion List -->
        <aside class="sidebar" :class="{ collapsed: sidebarCollapsed }">
            <div class="sidebar-header">
                <select x-model="selectedProject" @change="loadAssertionsByProject()" class="project-select">
                    <option value="">All Projects</option>
                    <template x-for="project in projects" :key="project.id">
                        <option :value="project.id" x-text="project.name"></option>
                    </template>
                </select>
            </div>

            <div class="assertion-list">
                <template x-if="getFilteredAssertionsByProject().length === 0">
                    <div class="empty-sidebar">
                        <p x-text="statusFilter ? 'No ' + statusFilter + ' assertions' : 'No assertions'"></p>
                    </div>
                </template>

                <template x-for="group in getFilteredAssertionsByProject()" :key="group.projectId">
                    <div class="project-section">
                        <button class="project-toggle" @click="group.expanded = !group.expanded">
                            <span class="project-name" x-text="group.projectName"></span>
                            <span class="project-count" x-text="group.assertions.length"></span>
                            <svg class="chevron" :class="{ expanded: group.expanded }" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6 9l6 6 6-6"/>
                            </svg>
                        </button>

                        <div class="project-items" x-show="group.expanded" x-collapse>
                            <template x-for="assertion in group.assertions" :key="assertion.id">
                                <button
                                    class="assertion-item"
                                    :class="{
                                        selected: currentAssertionId === assertion.id,
                                        completed: getAssertionStatus(assertion.id, assertion.status) === 'validated' || getAssertionStatus(assertion.id, assertion.status) === 'rejected'
                                    }"
                                    @click="selectAssertion(assertion)"
                                >
                                    <span class="assertion-status-dot" :class="getAssertionStatus(assertion.id, assertion.status)"></span>
                                    <span class="assertion-preview" x-text="assertion.claim"></span>
                                    <span class="assertion-criticality" :class="assertion.criticality?.toLowerCase()" x-text="assertion.criticality?.charAt(0)"></span>
                                </button>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </aside>

        <!-- Content Area -->
        <section class="content" :class="{ 'panel-open': assertionPanelOpen && currentAssertionId }">
            <!-- Empty State -->
            <template x-if="!currentAssertionId">
                <div class="empty-content">
                    <div class="empty-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                    <h2>Select an assertion</h2>
                    <p>Choose from the sidebar to begin validation</p>
                </div>
            </template>

            <!-- Assertion View - Split Layout -->
            <template x-if="currentAssertionId">
                <div class="assertion-view">
                    <!-- Conversation Panel (primary - left on wide, bottom on narrow) -->
                    <div class="conversation-panel">
                        <!-- Chat Thread -->
                        <div class="chat-section">
                            <div class="chat-header">
                                <div class="chat-label">Conversation</div>
                                <button
                                    class="panel-toggle-btn"
                                    @click="toggleAssertionPanel()"
                                    :title="assertionPanelOpen ? 'Hide assertion details' : 'Show assertion details'"
                                >
                                    <svg x-show="!assertionPanelOpen" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                                        <path d="M15 3v18"/>
                                    </svg>
                                    <svg x-show="assertionPanelOpen" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                                        <path d="M15 3v18"/>
                                        <path d="M9 9l6 6M15 9l-6 6"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="chat-thread" x-ref="chatContainer">
                                <template x-for="(msg, index) in chatMessages" :key="index">
                                    <div class="message" :class="msg.role">
                                        <template x-if="msg.type === 'screenshot'">
                                            <div class="evidence-message">
                                                <img :src="msg.content" alt="Evidence" class="evidence-image">
                                                <a :href="msg.content" target="_blank" class="evidence-link">View full size</a>
                                            </div>
                                        </template>
                                        <template x-if="msg.type !== 'screenshot'">
                                            <div class="message-bubble" x-html="formatMessage(msg.content)"></div>
                                        </template>
                                    </div>
                                </template>

                                <!-- Streaming indicator -->
                                <template x-if="isStreaming">
                                    <div class="message assistant streaming">
                                        <div class="message-bubble">
                                            <span x-text="currentStreamText"></span>
                                            <span class="cursor"></span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Input Area -->
                        <div class="input-area">
                            <!-- Not started state -->
                            <template x-if="getAssertionStatus(currentAssertionId) === 'not_started'">
                                <div class="start-prompt">
                                    <template x-if="!validatorName">
                                        <p class="name-required">Enter your name above to begin</p>
                                    </template>
                                    <div class="start-actions">
                                        <button
                                            class="btn-assess"
                                            @click="requestAiAssessment()"
                                            :disabled="assessmentLoading"
                                        >
                                            <template x-if="!assessmentLoading">
                                                <span>Critically Assess with AI</span>
                                            </template>
                                            <template x-if="assessmentLoading">
                                                <span>Assessing...</span>
                                            </template>
                                        </button>
                                        <button
                                            class="btn-start"
                                            @click="startAssertionValidation()"
                                            :disabled="!authStatus.valid || !validatorName"
                                        >
                                            Begin Validation
                                        </button>
                                    </div>
                                </div>
                            </template>

                            <!-- Completed state -->
                            <template x-if="getAssertionStatus(currentAssertionId) === 'validated' || getAssertionStatus(currentAssertionId) === 'rejected'">
                                <div class="completed-message">
                                    Validation complete
                                </div>
                            </template>

                            <!-- Active validation -->
                            <template x-if="getAssertionStatus(currentAssertionId) === 'in_progress'">
                                <div class="active-input">
                                    <!-- Multiple screenshot previews -->
                                    <div class="screenshots-preview" x-show="pendingScreenshots.length > 0">
                                        <template x-for="screenshot in pendingScreenshots" :key="screenshot.id">
                                            <div class="screenshot-thumb">
                                                <img :src="screenshot.preview" alt="Screenshot">
                                                <button class="remove-screenshot" @click="removePendingScreenshot(screenshot.id)">
                                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M18 6L6 18M6 6l12 12"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </template>
                                        <button class="clear-all-screenshots" @click="clearPendingScreenshots()" x-show="pendingScreenshots.length > 1">
                                            Clear all
                                        </button>
                                    </div>

                                    <textarea
                                        x-model="userInput"
                                        @input="autoGrow($event)"
                                        @paste="handlePaste($event)"
                                        @keydown.ctrl.enter="submitWithAction('validate')"
                                        @keydown.meta.enter="submitWithAction('validate')"
                                        placeholder="Describe your verification... (Paste screenshots with Ctrl+V)"
                                        :disabled="isStreaming"
                                        class="validation-input"
                                        rows="1"
                                    ></textarea>

                                    <div class="action-buttons">
                                        <button
                                            class="btn-action question"
                                            @click="sendMessage()"
                                            :disabled="!userInput.trim() || isStreaming"
                                            title="Ask Claude a question"
                                        >
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="12" cy="12" r="10"/>
                                                <path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/>
                                                <path d="M12 17h.01"/>
                                            </svg>
                                            Ask
                                        </button>
                                        <button
                                            class="btn-action skip"
                                            @click="submitWithAction('skip')"
                                            :disabled="!userInput.trim() || isStreaming"
                                        >
                                            Skip
                                        </button>
                                        <button
                                            class="btn-action reject"
                                            @click="submitWithAction('reject')"
                                            :disabled="!userInput.trim() || isStreaming"
                                        >
                                            Reject
                                        </button>
                                        <button
                                            class="btn-action validate"
                                            @click="submitWithAction('validate')"
                                            :disabled="!userInput.trim() || isStreaming"
                                        >
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                                <path d="M20 6L9 17l-5-5"/>
                                            </svg>
                                            Validate
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Assertion Panel (secondary - right on wide, top on narrow) -->
                    <aside class="assertion-panel" :class="{ collapsed: !assertionPanelOpen }">
                        <div class="panel-header">
                            <span class="panel-title">Assertion</span>
                            <button class="panel-close-btn" @click="toggleAssertionPanel()" title="Close panel">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 6L6 18M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>

                        <div class="panel-content">
                            <!-- Claim Card -->
                            <div class="claim-card">
                                <div class="claim-meta">
                                    <span class="entity-name" x-text="currentAssertion?.entityName"></span>
                                    <span class="meta-separator">/</span>
                                    <span class="category" x-text="currentAssertion?.category"></span>
                                    <span class="criticality-tag" :class="currentAssertion?.criticality?.toLowerCase()" x-text="currentAssertion?.criticality"></span>
                                </div>

                                <div class="claim-container">
                                    <blockquote class="claim-text" x-text="currentAssertion?.claim"></blockquote>
                                    <div class="claim-actions">
                                        <button
                                            class="claim-action-btn"
                                            @click="copyClaimToClipboard()"
                                            title="Copy claim to clipboard"
                                        >
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                                <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                                            </svg>
                                        </button>
                                        <button
                                            class="claim-action-btn"
                                            @click="searchClaimOnWeb()"
                                            title="Search web for this claim"
                                        >
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="11" cy="11" r="8"/>
                                                <path d="M21 21l-4.35-4.35"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                                <!-- AI Assessment Panel -->
                                <template x-if="aiAssessment">
                                    <div class="ai-assessment-panel">
                                        <div class="assessment-header">
                                            <span class="assessment-verdict" :class="aiAssessment.verdict?.toLowerCase()?.replace('_', '-')" x-text="aiAssessment.verdict?.replace('_', ' ')"></span>
                                            <span class="assessment-confidence" x-text="aiAssessment.confidence + ' confidence'"></span>
                                            <button class="assessment-dismiss" @click="clearAiAssessment()" title="Dismiss">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M18 6L6 18M6 6l12 12"/>
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="assessment-reasoning" x-text="aiAssessment.reasoning"></div>
                                        <template x-if="aiAssessment.concerns">
                                            <div class="assessment-concerns">
                                                <strong>Concerns:</strong> <span x-text="aiAssessment.concerns"></span>
                                            </div>
                                        </template>
                                        <div class="assessment-recommendation">
                                            <strong>Focus on:</strong> <span x-text="aiAssessment.recommendation"></span>
                                        </div>
                                    </div>
                                </template>

                                <!-- Evidence Chain (Primary Evidence) -->
                                <template x-if="currentAssertion?.evidenceChain && currentAssertion.evidenceChain.length > 0">
                                    <div class="evidence-chain-section">
                                        <h4>Evidence</h4>
                                        <template x-for="(evidence, index) in currentAssertion.evidenceChain" :key="'evidence-chain-' + index">
                                            <div class="evidence-chain-item">
                                                <div class="evidence-chain-header">
                                                    <span class="evidence-badge" :class="evidence.source === 'agent' ? 'agent' : 'validation'" :title="evidence.source === 'agent' ? 'Agent-captured evidence' : 'Validation screenshot'">
                                                        <template x-if="evidence.source === 'agent'">A</template>
                                                        <template x-if="evidence.source !== 'agent'">V</template>
                                                    </span>
                                                    <a :href="'/' + evidence.screenshotPath" target="_blank" class="evidence-path" x-text="evidence.screenshotPath.split('/').pop()"></a>
                                                </div>
                                                <div class="evidence-thumb-container">
                                                    <a :href="'/' + evidence.screenshotPath" target="_blank">
                                                        <img :src="'/' + evidence.screenshotPath" alt="Evidence screenshot" class="evidence-chain-thumb">
                                                    </a>
                                                </div>
                                                <p class="evidence-description" x-text="evidence.description"></p>
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <!-- Primary Evidence Description (if no chain but has description) -->
                                <template x-if="(!currentAssertion?.evidenceChain || currentAssertion.evidenceChain.length === 0) && currentAssertion?.evidenceDescription">
                                    <div class="evidence-chain-section">
                                        <h4>Evidence</h4>
                                        <div class="evidence-chain-item">
                                            <template x-if="currentAssertion.evidenceScreenshotPath">
                                                <div class="evidence-thumb-container">
                                                    <a :href="'/' + currentAssertion.evidenceScreenshotPath" target="_blank">
                                                        <img :src="'/' + currentAssertion.evidenceScreenshotPath" alt="Evidence screenshot" class="evidence-chain-thumb">
                                                    </a>
                                                </div>
                                            </template>
                                            <p class="evidence-description" x-text="currentAssertion.evidenceDescription"></p>
                                        </div>
                                    </div>
                                </template>

                                <!-- Reference URLs (formerly Sources) -->
                                <template x-if="currentAssertion?.sources && currentAssertion.sources.length > 0">
                                    <div class="sources-section">
                                        <h4>Reference URLs</h4>
                                        <template x-for="source in currentAssertion.sources" :key="source.id">
                                            <div class="source-card" :class="{ graded: source.relevanceGrade, 'researcher-added': source.addedBy }">
                                                <div class="source-header">
                                                    <template x-if="source.addedBy">
                                                        <span class="source-badge researcher" title="Added by researcher">R</span>
                                                    </template>
                                                    <template x-if="!source.addedBy">
                                                        <span class="source-badge agent" title="Agent-provided">A</span>
                                                    </template>
                                                    <a :href="source.url" target="_blank" rel="noopener" class="source-url" x-text="truncateUrl(source.url)"></a>
                                                    <button class="source-expand-btn" @click="source.expanded = !source.expanded" :title="source.expanded ? 'Collapse' : 'Expand'">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path :d="source.expanded ? 'M18 15l-6-6-6 6' : 'M6 9l6 6 6-6'"/>
                                                        </svg>
                                                    </button>
                                                </div>

                                                <template x-if="source.quote">
                                                    <p class="source-quote" x-text="source.quote"></p>
                                                </template>

                                                <!-- Grade Badge (when collapsed) -->
                                                <template x-if="source.relevanceGrade && !source.expanded">
                                                    <span class="grade-badge" :class="source.relevanceGrade?.toLowerCase()?.replace('_', '-')" x-text="formatGrade(source.relevanceGrade)"></span>
                                                </template>

                                                <!-- Expanded: Grading Controls -->
                                                <div class="source-grading" x-show="source.expanded" x-collapse>
                                                    <div class="grade-selector">
                                                        <label>Relevance</label>
                                                        <div class="grade-options">
                                                            <button
                                                                class="grade-btn direct"
                                                                :class="{ active: source.relevanceGrade === 'DIRECT_EVIDENCE' }"
                                                                @click="gradeSource(source.id, 'DIRECT_EVIDENCE')"
                                                                title="Source directly proves the assertion"
                                                            >Direct</button>
                                                            <button
                                                                class="grade-btn strong"
                                                                :class="{ active: source.relevanceGrade === 'STRONG_SUPPORT' }"
                                                                @click="gradeSource(source.id, 'STRONG_SUPPORT')"
                                                                title="Strongly supports with related evidence"
                                                            >Strong</button>
                                                            <button
                                                                class="grade-btn partial"
                                                                :class="{ active: source.relevanceGrade === 'PARTIAL_SUPPORT' }"
                                                                @click="gradeSource(source.id, 'PARTIAL_SUPPORT')"
                                                                title="Partially addresses the claim"
                                                            >Partial</button>
                                                            <button
                                                                class="grade-btn weak"
                                                                :class="{ active: source.relevanceGrade === 'WEAK_SUPPORT' }"
                                                                @click="gradeSource(source.id, 'WEAK_SUPPORT')"
                                                                title="Tangentially related"
                                                            >Weak</button>
                                                            <button
                                                                class="grade-btn not-relevant"
                                                                :class="{ active: source.relevanceGrade === 'NOT_RELEVANT' }"
                                                                @click="gradeSource(source.id, 'NOT_RELEVANT')"
                                                                title="Doesn't actually support the claim"
                                                            >N/A</button>
                                                            <button
                                                                class="grade-btn misleading"
                                                                :class="{ active: source.relevanceGrade === 'MISLEADING' }"
                                                                @click="gradeSource(source.id, 'MISLEADING')"
                                                                title="Misinterpreted or contradicts claim"
                                                            >Wrong</button>
                                                        </div>
                                                    </div>

                                                    <div class="annotation-field">
                                                        <label>Notes <span class="optional">(for agent improvement)</span></label>
                                                        <textarea
                                                            :value="source.annotation || ''"
                                                            @blur="saveSourceAnnotation(source.id, $event.target.value)"
                                                            placeholder="Why this grade? What should the agent do differently?"
                                                            rows="2"
                                                        ></textarea>
                                                    </div>

                                                    <template x-if="source.gradedBy">
                                                        <div class="grade-meta">
                                                            Graded by <span x-text="source.gradedBy"></span>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <!-- Reasoning -->
                                <template x-if="currentAssertion?.reasoning && currentAssertion.reasoning.length > 0">
                                    <div class="reasoning-section">
                                        <h4>Reasoning</h4>
                                        <template x-for="r in currentAssertion.reasoning" :key="r.id">
                                            <p class="reasoning-text" x-text="r.content"></p>
                                        </template>
                                    </div>
                                </template>
                            </div>

                            <!-- Status Banner (if completed) -->
                            <template x-if="getAssertionStatus(currentAssertionId) === 'validated'">
                                <div class="status-banner validated">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M20 6L9 17l-5-5"/>
                                    </svg>
                                    <span>Validated</span>
                                </div>
                            </template>
                            <template x-if="getAssertionStatus(currentAssertionId) === 'rejected'">
                                <div class="status-banner rejected">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M18 6L6 18M6 6l12 12"/>
                                    </svg>
                                    <span>Rejected</span>
                                </div>
                            </template>

                            <!-- Evidence Screenshots -->
                            <template x-if="chatMessages.filter(m => m.type === 'screenshot').length > 0">
                                <div class="evidence-gallery">
                                    <h4>Evidence</h4>
                                    <div class="evidence-grid">
                                        <template x-for="(msg, index) in chatMessages.filter(m => m.type === 'screenshot')" :key="'evidence-' + index">
                                            <a :href="msg.content" target="_blank" class="evidence-thumb">
                                                <img :src="msg.content" alt="Evidence screenshot">
                                            </a>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </aside>
                </div>
            </template>
        </section>
    </main>

    <script src="/app.js"></script>
</body>
</html>
